{% extends 'base.html' %}
{% load bootstrap5 %}

{% block content %}
<style>
    /* 파스텔 색상 정의 */
    .badge.pastel-available { background-color: #E3F2FD !important; color: #1976D2 !important; }
    .badge.pastel-requested { background-color: #FFF9C4 !important; color: #F57F17 !important; }
    .badge.pastel-approved { background-color: #FFCDD2 !important; color: #D32F2F !important; }
    .badge.pastel-cancelled { background-color: #E0E0E0 !important; color: #424242 !important; }
    .badge.pastel-create { background-color: #E3F2FD !important; color: #1976D2 !important; }
    .badge.pastel-approve { background-color: #E8F5E8 !important; color: #388E3C !important; }
    .badge.pastel-delete { background-color: #E0E0E0 !important; color: #424242 !important; }
    .badge.pastel-update { background-color: #FFF3E0 !important; color: #F57C00 !important; }
    .badge.pastel-other { background-color: #F5F5F5 !important; color: #616161 !important; }
    .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .table-dark { background-color: #37474F !important; }
    
    /* 로그 테이블 컴팩트 스타일 */
    .log-table {
        font-size: 0.85rem;
    }
    .log-table th {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
        vertical-align: middle;
    }
    .log-table td {
        padding: 0.5rem 0.75rem;
        vertical-align: middle;
        line-height: 1.3;
    }
    .log-table .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    .log-table small {
        font-size: 0.75rem;
    }
</style>
<div class="container-fluid" style="margin-top: 8rem;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div></div>
                <h2 class="text-center mb-0"><i class="fas fa-search"></i> 로그 검색</h2>
                <div>
                    <a href="{% url 'logapp:log_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 로그 목록으로
                    </a>
                </div>
            </div>
            
            <!-- 검색 폼 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> 검색 조건</h5>
                </div>
                <div class="card-body">
                    <form id="search-form">
                        <div class="row">
                            <!-- 검색 유형 -->
                            <div class="col-md-3 mb-3">
                                <label for="search-type" class="form-label">검색 유형</label>
                                <select class="form-select" id="search-type" name="type">
                                    <option value="all">전체 검색</option>
                                    <option value="date_time">날짜/시간</option>
                                    <option value="user">사용자</option>
                                    <option value="notes">메모</option>
                                </select>
                            </div>
                            
                            <!-- 검색 키워드 -->
                            <div class="col-md-3 mb-3">
                                <label for="keyword" class="form-label">검색어</label>
                                <input type="text" class="form-control" id="keyword" name="keyword" 
                                       placeholder="검색할 내용을 입력하세요">
                            </div>
                            
                            <!-- 시작 날짜 -->
                            <div class="col-md-3 mb-3">
                                <label for="start-date" class="form-label">시작 날짜 <small class="text-muted">(로그 생성일 기준)</small></label>
                                <input type="date" class="form-control" id="start-date" name="start_date">
                            </div>
                            
                            <!-- 종료 날짜 -->
                            <div class="col-md-3 mb-3">
                                <label for="end-date" class="form-label">종료 날짜 <small class="text-muted">(로그 생성일 기준)</small></label>
                                <input type="date" class="form-control" id="end-date" name="end_date">
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- 예약 날짜 -->
                            <div class="col-md-3 mb-3">
                                <label for="booking-date" class="form-label">예약 날짜 <small class="text-muted">(예약 슬롯 기준)</small></label>
                                <input type="date" class="form-control" id="booking-date" name="booking_date">
                            </div>
                            
                            <!-- 예약 시간 -->
                            <div class="col-md-3 mb-3">
                                <label for="booking-time" class="form-label">예약 시간 <small class="text-muted">(예약 슬롯 기준)</small></label>
                                <input type="time" class="form-control" id="booking-time" name="booking_time">
                            </div>
                            
                            <!-- 액션 타입 -->
                            <div class="col-md-3 mb-3">
                                <label for="action-type" class="form-label">액션 타입</label>
                                <select class="form-select" id="action-type" name="action_type">
                                    <option value="">전체</option>
                                    <option value="CREATE">예약 생성</option>
                                    <option value="UPDATE">예약 변경</option>
                                    <option value="DELETE">예약 취소</option>
                                    <option value="APPROVE">예약 승인</option>
                                    <option value="REJECT">예약 거절</option>
                                    <option value="BLOCK">예약 차단</option>
                                    <option value="UNBLOCK">예약 차단 해제</option>
                                </select>
                            </div>
                            
                            <!-- 사용자 ID -->
                            <div class="col-md-3 mb-3">
                                <label for="user-id" class="form-label">사용자 ID</label>
                                <input type="number" class="form-control" id="user-id" name="user_id" 
                                       placeholder="사용자 ID (선택사항)">
                            </div>
                            
                            <!-- 검색 버튼 -->
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> 검색
                                </button>
                                <button type="button" class="btn btn-secondary" id="reset-form">
                                    <i class="fas fa-undo"></i> 초기화
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 검색 결과 -->
            <div class="card" id="search-results" style="display: none;">
                <div class="card-header">
                    <h5 id="result-title"><i class="fas fa-list"></i> 검색 결과</h5>
                </div>
                <div class="card-body">
                    <div id="results-table"></div>
                    <div id="pagination-controls"></div>
                </div>
            </div>
            
            <!-- 로딩 스피너 -->
            <div class="text-center py-5" id="loading" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">검색 중...</span>
                </div>
                <p class="mt-2">검색 중입니다...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const resultsDiv = document.getElementById('search-results');
    const loadingDiv = document.getElementById('loading');
    const resultsTable = document.getElementById('results-table');
    const paginationControls = document.getElementById('pagination-controls');
    const resultTitle = document.getElementById('result-title');
    const resetButton = document.getElementById('reset-form');
    
    // 기본 날짜 설정하지 않음 - 사용자가 필요한 조건만 선택
    
    // 검색 폼 제출 이벤트
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch(1);
    });
    
    // 초기화 버튼
    resetButton.addEventListener('click', function() {
        searchForm.reset();
        resultsDiv.style.display = 'none';
    });
    
    function performSearch(page = 1) {
        const formData = new FormData(searchForm);
        const params = new URLSearchParams(formData);
        params.append('page', page);
        
        loadingDiv.style.display = 'block';
        resultsDiv.style.display = 'none';
        
        fetch(`{% url 'logapp:log_search_api' %}?${params}`)
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                displayResults(data);
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                console.error('검색 오류:', error);
                alert('검색 중 오류가 발생했습니다.');
            });
    }
    
    function displayResults(data) {
        resultTitle.innerHTML = `<i class="fas fa-list"></i> 검색 결과 (${data.pagination.total_count}건)`;
        resultsDiv.style.display = 'block';
        
        if (data.logs.length === 0) {
            resultsTable.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">검색 결과가 없습니다.</p>
                </div>
            `;
            paginationControls.innerHTML = '';
            return;
        }
        
        // 결과 테이블 생성
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover log-table">
                    <thead class="table-dark">
                        <tr>
                            <th>시간</th>
                            <th>액션</th>
                            <th>예약 날짜/시간</th>
                            <th>예약자</th>
                            <th>변경자</th>
                            <th>이전 → 현재 상태</th>
                            <th>메모</th>
                            <th>상세</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.logs.forEach(log => {
            const actionBadge = getActionBadge(log.action_type_code, log.action_type);
            tableHtml += `
                <tr>
                    <td><small>${log.created_at}</small></td>
                    <td>${actionBadge}</td>
                    <td>
                        <strong>${log.booking_date}</strong><br>
                        <small class="text-muted">${log.booking_time}</small>
                    </td>
                    <td>${log.user_display || '-'}</td>
                    <td>${log.modifier_display || '시스템'}</td>
                    <td>
                        ${log.previous_status ? 
                            `<span class="badge ${getStatusBadgeClass(log.previous_status)}">${log.previous_status}</span> <span class="mx-2" style="color: #333; font-weight: bold;">→</span> ` 
                            : ''}
                        <span class="badge ${getStatusBadgeClass(log.new_status)}">${log.new_status}</span>
                    </td>
                    <td><small>${log.notes ? log.notes.substring(0, 50) : ''}</small></td>
                    <td>
                        <a href="/log/booking/${log.booking_date}/${log.booking_time}/" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-calendar"></i>
                        </a>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table></div>';
        resultsTable.innerHTML = tableHtml;
        
        // 페이지네이션 생성
        createPagination(data.pagination);
    }
    
    function getActionBadge(code, display) {
        // 액션 표시명에 따라 일관성 있게 색상 지정
        if (display === '예약취소') {
            return `<span class="badge pastel-cancelled">${display}</span>`;
        } else if (display === '예약요청') {
            return `<span class="badge pastel-requested">${display}</span>`;  // 노란색
        } else if (display === '예약승인') {
            return `<span class="badge pastel-approved">${display}</span>`;   // 붉은색
        } else {
            // 기존 코드 방식으로 처리
            const badges = {
                'CREATE': 'pastel-create',
                'APPROVE': 'pastel-approved', 
                'DELETE': 'pastel-cancelled',
                'UPDATE': 'pastel-update',
                'REJECT': 'pastel-other',
                'BLOCK': 'pastel-other',
                'UNBLOCK': 'pastel-other'
            };
            const badgeClass = badges[code] || 'pastel-other';
            return `<span class="badge ${badgeClass}">${display}</span>`;
        }
    }
    
    function getStatusBadgeClass(status) {
        const statusClasses = {
            '예약가능': 'pastel-available',
            '예약요청': 'pastel-requested',
            '예약승인': 'pastel-approved',
            '예약취소': 'pastel-cancelled',
            '삭제됨': 'pastel-cancelled'
        };
        return statusClasses[status] || 'pastel-cancelled';
    }
    
    function createPagination(pagination) {
        if (pagination.total_pages <= 1) {
            paginationControls.innerHTML = '';
            return;
        }
        
        let paginationHtml = '<nav aria-label="검색 결과 페이지네이션"><ul class="pagination justify-content-center">';
        
        // 이전 페이지
        if (pagination.has_previous) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="1">&laquo; 처음</a></li>`;
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.page - 1}">이전</a></li>`;
        }
        
        // 현재 페이지
        paginationHtml += `<li class="page-item active"><span class="page-link">${pagination.page} / ${pagination.total_pages}</span></li>`;
        
        // 다음 페이지
        if (pagination.has_next) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.page + 1}">다음</a></li>`;
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.total_pages}">마지막 &raquo;</a></li>`;
        }
        
        paginationHtml += '</ul></nav>';
        paginationControls.innerHTML = paginationHtml;
        
        // 페이지 링크 이벤트 추가
        paginationControls.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                performSearch(page);
            });
        });
    }
});
</script>
{% endblock %}